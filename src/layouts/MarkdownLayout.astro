---
import Layout from "./Layout.astro";
import type { HeadTags } from "@/components/seo/SEOTags.astro";

type Props = HeadTags & {
  bodyClass?: string;
  mainClass?: string;
};

const { bodyClass, mainClass, ...layoutProps } = Astro.props as Props;
---

<Layout {...layoutProps}>
  <main
    id="main"
    class:list={[
      "mx-auto flex max-w-3xl flex-col gap-10 px-4 py-12 md:gap-14 md:px-0 md:py-20",
      mainClass,
    ]}
  >
    <slot name="header" />

    <article class:list={["markdown-body", bodyClass]}>
      <slot />
    </article>

    <slot name="footer" />
  </main>
</Layout>

<script>
  const copyButtonLabel = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
  const copiedButtonLabel = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>`;
  const codeBlocks = Array.from(document.querySelectorAll("pre"));

  for (const codeBlock of codeBlocks) {
    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";

    const copyButton = document.createElement("button");
    copyButton.className =
      "copy-code absolute right-3 top-3 rounded bg-slate-700/50 p-1 text-sky-100 opacity-0 transition-opacity duration-200 hover:bg-slate-600";
    copyButton.innerHTML = copyButtonLabel;

    codeBlock.setAttribute("tabindex", "0");
    codeBlock.appendChild(copyButton);

    // wrap codeBlock with relative parent element
    codeBlock.parentNode?.insertBefore(wrapper, codeBlock);
    wrapper.appendChild(codeBlock);

    copyButton.addEventListener("click", async () => {
      await copyCode(codeBlock, copyButton);
    });
  }

  async function copyCode(block: HTMLPreElement, button: HTMLButtonElement) {
    const code = block.querySelector("code");
    const text = code?.innerText;

    await navigator.clipboard.writeText(text ?? "");

    // visual feedback that task is completed
    button.innerHTML = copiedButtonLabel;

    setTimeout(() => {
      button.innerHTML = copyButtonLabel;
    }, 700);
  }
</script>

<style is:global>
  .markdown-body {
    @apply space-y-6 text-base leading-relaxed text-sky-950 dark:text-sky-100 md:text-lg;
  }

  .markdown-body > :where(* + *) {
    @apply mt-8;
  }

  .markdown-body :where(h1) {
    @apply text-3xl font-extrabold tracking-tight text-sky-950 dark:text-sky-100 md:text-4xl;
  }

  .markdown-body :where(h2) {
    @apply mt-10 text-2xl font-semibold text-sky-900 dark:text-sky-100 md:text-3xl;
  }

  .markdown-body :where(h3) {
    @apply mt-8 text-xl font-semibold text-sky-900 dark:text-sky-100 md:text-2xl;
  }

  .markdown-body :where(h4) {
    @apply mt-6 text-lg font-semibold text-sky-900 dark:text-sky-100;
  }

  .markdown-body :where(h5) {
    @apply mt-5 text-base font-semibold uppercase tracking-wide text-sky-800 dark:text-sky-300;
  }

  .markdown-body :where(p) {
    @apply leading-7 text-sky-950 dark:text-sky-100;
  }

  .markdown-body :where(a) {
    @apply font-medium text-sky-800 underline underline-offset-4 transition-colors hover:text-sky-600 dark:text-sky-200 dark:hover:text-sky-100;
  }

  .markdown-body :where(ul) {
    @apply my-6 list-disc space-y-2 pl-6 text-sky-950 dark:text-sky-100;
  }

  .markdown-body :where(ol) {
    @apply my-6 list-decimal space-y-2 pl-6 text-sky-950 dark:text-sky-100;
  }

  .markdown-body :where(li) {
    @apply leading-7;
  }

  .markdown-body :where(code) {
    @apply rounded-md bg-sky-100 px-2 py-1 font-mono text-sm font-semibold text-sky-900 shadow-sm dark:bg-slate-800 dark:text-sky-100;
  }

  .markdown-body :where(pre) {
    @apply relative overflow-x-auto rounded-xl bg-slate-900/95 p-0 text-sm text-sky-100 shadow-lg dark:bg-slate-900;
  }

  .markdown-body :where(pre):hover .copy-code {
    opacity: 1;
  }

  .markdown-body :where(pre > code) {
    @apply block min-w-full border-0 bg-transparent p-4 text-[0.95rem] font-mono font-normal leading-7 text-inherit;
  }

  .markdown-body :where(blockquote) {
    @apply my-10 border-l-4 border-sky-500/70 bg-sky-100/60 p-6 italic text-sky-900 dark:border-sky-400/60 dark:bg-sky-900/30 dark:text-sky-100;
  }

  .markdown-body :where(blockquote > * + *) {
    @apply mt-4;
  }

  .markdown-body :where(hr) {
    @apply my-12 border-sky-200/70 dark:border-sky-800/50;
  }

  .markdown-body :where(img, video) {
    @apply my-8 w-full rounded-xl border border-sky-200/60 shadow-md dark:border-sky-800/60;
  }

  .markdown-body :where(figure) {
    @apply my-10 flex flex-col gap-3;
  }

  .markdown-body :where(figcaption) {
    @apply text-sm text-sky-700 dark:text-sky-300;
  }

  .markdown-body :where(table) {
    @apply my-8 w-full table-auto border-separate border-spacing-y-2 text-left;
  }

  .markdown-body :where(th) {
    @apply border-b border-sky-300/70 pb-2 text-xs font-semibold uppercase tracking-wide text-sky-800 dark:border-sky-700/60 dark:text-sky-200;
  }

  .markdown-body :where(td) {
    @apply border-b border-sky-200/60 py-3 text-base leading-7 text-sky-900 dark:border-sky-800/60 dark:text-sky-100;
  }
</style>
